---
title: "Covid 19 DataSet"
author: "Jessie Black"
date: "2023-02-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Covid-19

## Libraries
```{r lib, echo=FALSE}
library(tidyverse)
library(lubridate)
```

## Data Collection

Record & combine URLs for desired .csv files.
```{r data, echo=TRUE}
url_in <- "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_time_series/"
file_names <- c("time_series_covid19_confirmed_US.csv", "time_series_covid19_confirmed_global.csv", "time_series_covid19_deaths_US.csv", "time_series_covid19_deaths_global.csv", "time_series_covid19_recovered_global.csv")
urls <- str_c(url_in, file_names)
```

Read in data sets.
```{r import_data, message=FALSE}
US_cases <- read_csv(urls[1])
global_cases <- read_csv(urls[2])
US_deaths <- read_csv(urls[3])
global_deaths <- read_csv(urls[4])
```

Tidy datasets by putting each variable in its own column, and disregarding Lat & Lon. Renaming region & state to be easier to use in R.
```{r tidy_global_data}
global_cases <- global_cases %>% 
  pivot_longer(cols= -c('Province/State', 'Country/Region', Lat, Long), # All column headings except for these
                                              names_to = "date",        # will now go as observations under new column "date"
                                              values_to = "cases") %>%  # and their respective values will now go under the column "cases"
  select(-c(Lat,Long))    # Lat and Long will be excluded
global_deaths <- global_deaths %>%  # Same adjustment made to global_deaths data
  pivot_longer(cols= -c('Province/State', 'Country/Region', Lat, Long), 
                                              names_to = "date",       
                                              values_to = "deaths") %>%  
  select(-c(Lat,Long))
```

Consolidate deaths and cases into single global set
```{r combine_global_data}
global <- global_cases %>% 
  full_join(global_deaths) %>%
  rename(Country_Region = 'Country/Region',
         Province_State = 'Province/State') %>%
  mutate(date = mdy(date))
```

Explore new data set
``` {r summarize_global_data}
summary(global)
```
Get rid of observations with 0 cases
``` {r remove_negative_cases}
global <- global %>% filter(cases >0)
summary(global)
```
Check that upper observation of cases is not a typo
``` {r check_max_cases}
global %>% filter(cases>100000000)
```

Tidy up US cases and US deaths
```{r tidy_US_data}
US_cases <- US_cases %>%
  pivot_longer(cols = -(UID:Combined_Key),
               names_to = "date",
               values_to = "cases") %>%
  select(Admin2:cases)%>%
  mutate(date=mdy(date)) %>%
  select(-c(Lat,Long_))

US_deaths <- US_deaths %>%
  pivot_longer(cols = -(UID:Combined_Key),
               names_to = "date",
               values_to = "deaths") %>%
  select(Admin2:deaths)%>%
  mutate(date=mdy(date)) %>%
  select(-c(Lat,Long_))
```

Combine US data sets
``` {r combine_US_data}
US <- US_cases %>%
  full_join(US_deaths) %>%
  filter(!is.na(date))
```

Make combined key for global data
``` {r create_global_combined_key}
global <- global %>% 
  unite("Combined_Key",
        c(Province_State, Country_Region),
        sep = ", ",
        na.rm = TRUE,
        remove = FALSE)
```

Get population data from UID Lookup Table
``` {r uid_lookup}
uid_lookup_url <- "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/UID_ISO_FIPS_LookUp_Table.csv"
uid <- read_csv(uid_lookup_url) %>%
  select(-c(Lat, Long_, Combined_Key, code3, iso2, iso3))
```

Join population data from UID table with global data set
```{r add_population_global}
global <- global %>%
  left_join(uid, by = c("Province_State", "Country_Region")) %>%
  select(-c(UID, FIPS)) %>%
  select(Province_State, Country_Region, date, cases,
         deaths, Population, Combined_Key)
```

Isolate US population data from UID table 
```{r get_population_US}
US_uid <- uid %>%
  filter(Country_Region == "US") %>%
  select(-c(UID, FIPS))
```

Join population data from UID table with US data set
```{r add_population_US}
US <- US %>%
  left_join(uid, by = c("Admin2", "Province_State", "Country_Region")) %>%
  select(-c(UID, FIPS)) %>%
  select(Province_State, Country_Region, date, cases,
         deaths, Population, Combined_Key)
```

## Visualizing, Analyzing & Modelling Data
Group Covid cases by location & summarize.
```{r group_cases}
US_by_state <- US %>%
  group_by(Province_State, Country_Region, date) %>%
  summarize(cases = sum(cases), deaths = sum(deaths)) %>%
  select(Province_State, Country_Region, date, cases, deaths) %>%
  ungroup()
```

```{r us_totals}
US_totals <- US_by_state %>%
  group_by(Country_Region, date) %>%
  summarize(cases = sum(cases), deaths = sum(deaths)) %>%
  select(Country_Region, date, cases, deaths) %>%
  ungroup()
```

Visualize results
```{r visualization_total_cases}
US_totals %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = cases)) + 
  geom_line(aes(color = "cases")) + 
  geom_point(aes(color = "cases")) + 
  geom_line(aes(y = deaths, color = "deaths")) + 
  geom_point(aes(y = deaths, color = "deaths")) + 
  scale_y_log10() + 
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + 
  labs(title = "COVID19 in US", y = NULL)
```

Examine individual states
```{r visualization_single_state}
state <- "New York"
US_by_state %>%
  filter(Province_State == state) %>%
  filter(cases > 0) %>%
  ggplot(aes(x = date, y = cases)) + 
  geom_line(aes(color = "cases")) + 
  geom_point(aes(color = "cases")) + 
  geom_line(aes(y = deaths, color = "deaths")) + 
  geom_point(aes(y = deaths, color = "deaths")) + 
  scale_y_log10() + 
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + 
  labs(title = str_c("COVID19 in ", state), y = NULL)
```

Get latest date
```{r max_date}
max(US_totals$date)
```

Get most recent number of deaths
```{r max_deaths}
max(US_totals$deaths)
```

Check if cases have leveled off
```{r add_lag}
US_by_state <- US_by_state %>%
  mutate(new_cases = cases - lag(cases),
         new_deaths = deaths - lag(deaths))
US_totals <- US_totals %>%
  mutate(new_cases = cases - lag(cases),
         new_deaths = deaths - lag(deaths))
```

Look at most recent numbers, prioritizing new cases & new deaths
```{r tail_totals}
tail(US_totals %>% select(new_cases, new_deaths, everything()))
```

Visualize new cases and new deaths
```{r visualization_total_new_cases}
US_totals %>%
  ggplot(aes(x = date, y = new_cases)) + 
  geom_line(aes(color = "new_cases")) + 
  geom_point(aes(color = "new_cases")) + 
  geom_line(aes(y = new_deaths, color = "new_deaths")) + 
  geom_point(aes(y = new_deaths, color = "new_deaths")) + 
  scale_y_log10() + 
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + 
  labs(title = "COVID19 in US", y = NULL)
```

Visualize new cases and new deaths in an individual state
```{r visualization_state_new_cases}
state <- "California"
US_by_state %>%
  filter(Province_State == state) %>%
  ggplot(aes(x = date, y = new_cases)) + 
  geom_line(aes(color = "new_cases")) + 
  geom_point(aes(color = "new_cases")) + 
  geom_line(aes(y = new_deaths, color = "new_deaths")) + 
  geom_point(aes(y = new_deaths, color = "new_deaths")) + 
  scale_y_log10() + 
  theme(legend.position = "bottom", axis.text.x = element_text(angle = 90)) + 
  labs(title = str_c("COVID19 in ", state), y = NULL)
```
Adjust for population density in global cases
``` {r global_population_density}
global <- global %>%
  mutate(cases_per_thou = cases*1000/Population, deaths_per_thou = deaths*1000/Population)
```

Model the relationship between deaths and cases
``` {r model_global_linear_relationship}
mod <- lm(deaths_per_thou ~ cases_per_thou, data = global)
summary(mod)
```

Get largest and smallest cases and deaths per thousand
``` {r min_max_cases_per_thou}
today <- as.Date(format(Sys.Date(), "%Y-%m-%d"))
last_week <- as.Date(today - 5)
global %>% filter(date == last_week) %>% slice_min(cases_per_thou)
global %>% filter(date == last_week) %>% slice_max(cases_per_thou)
global %>% filter(date == last_week) %>% slice_min(deaths_per_thou)
global %>% filter(date == last_week) %>% slice_max(deaths_per_thou)
```

